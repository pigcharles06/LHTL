<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學習活動 - 作品分享</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* FontFace, Lucide */
      @font-face {
        font-family: 'LucideIcons';
        src: url(https://cdn.jsdelivr.net/npm/lucide-static@latest/font/Lucide.ttf) format('truetype');
      }
      .lucide { font-family: 'LucideIcons'; font-size: 1.25rem; line-height: 1; }
      /* FadeIn Animation */
      .fade-in { animation: fadeIn 0.8s ease-in-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

      /* --- Particles.js Container Style --- */
      #particles-js {
        position: fixed; width: 100%; height: 100%;
        top: 0; left: 0; z-index: -1; /* Behind content */
        background-color: transparent;
      }

      /* Interactive Cat Styles */
      #interactive-cat-container {
        position: fixed; bottom: 20px; right: 20px;
        width: 80px; height: 80px;
        cursor: pointer; user-select: none; z-index: 40;
        background-color: rgba(200, 200, 200, 0.1); border-radius: 50%;
      }
      #interactive-cat-img {
        width: 100%; height: 100%; object-fit: contain;
        -webkit-user-drag: none; user-select: none; -moz-user-select: none;
        -webkit-user-select: none; -ms-user-select: none;
      }

      /* Custom styles for form elements if needed */
      #upload-form textarea { min-height: 80px; }
      #upload-form input[type="file"] {
          /* Basic styling for file input */
          border: 1px solid #E5E7EB; border-radius: 0.5rem; padding: 0.5rem;
      }
      /* Style for the gallery cards */
      .work-card {
          background-color: white;
          border-radius: 1rem; /* rounded-xl */
          box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); /* shadow-lg */
          overflow: hidden;
          transition: transform 0.3s ease;
          display: flex; /* Use flexbox for better control */
          flex-direction: column; /* Stack image and text vertically */
      }
      .work-card:hover {
          transform: scale(1.03);
      }
      .work-card img {
          width: 100%;
          height: 200px; /* Fixed height for consistency */
          object-fit: cover; /* Cover the area, may crop */
          flex-shrink: 0; /* Prevent image from shrinking */
      }
      .work-card p {
          padding: 1rem; /* p-4 */
          font-size: 0.875rem; /* text-sm */
          color: #4B5563; /* text-gray-600 */
          /* Allow line breaks and wrap long words */
          white-space: pre-wrap;
          word-wrap: break-word;
          flex-grow: 1; /* Allow text block to grow if needed */
          margin-top: auto; /* Push text down if image is short? Not needed with fixed height */
      }
      /* Style for submit button when disabled */
      button:disabled {
            cursor: not-allowed;
            opacity: 0.7;
       }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        // Tailwind Config (Using initial colors)
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: '#F8BBD0',   // 淡粉色
                        secondary: '#FFF8E1', // 柔和米色 (主背景)
                        accent: '#E91E63',   // 亮粉色
                        text: '#424242',     // 深灰色文字
                        gray: { 100: '#F3F4F6', 200: '#E5E7EB', 300: '#D1D5DB', 500:'#6B7280', 600:'#4B5563', 700:'#374151', 800:'#1F2937'} // Added more grays
                    },
                    borderRadius: { 'xl': '1rem', '2xl': '1.5rem' }
                }
            }
        }
    </script>
</head>
<body class="font-sans bg-secondary text-text antialiased">

    <div id="particles-js"></div>

    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="#home" class="text-2xl font-bold text-accent hover:text-primary transition duration-300">活動 Logo</a>
            <div class="hidden md:flex space-x-6">
                <a href="#home" class="text-gray-600 hover:text-accent transition duration-300">活動首頁</a>
                <a href="#student-works" class="text-gray-600 hover:text-accent transition duration-300">作品展示/上傳</a>
                </div>
            <button id="mobile-menu-button" class="md:hidden lucide text-gray-600 hover:text-accent transition duration-300">&#xe9af;</button>
        </nav>
        <div id="mobile-menu" class="md:hidden hidden bg-white py-2">
            <a href="#home" class="block px-6 py-2 text-gray-600 hover:bg-gray-100 hover:text-accent">活動首頁</a>
            <a href="#student-works" class="block px-6 py-2 text-gray-600 hover:bg-gray-100 hover:text-accent">作品展示/上傳</a>
        </div>
    </header>

    <main>
        <section id="home" class="container mx-auto px-6 py-16 md:py-24 fade-in">
             <div class="flex flex-col md:flex-row items-center gap-12">
                <div class="md:w-1/2 text-center md:text-left">
                     <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-4 leading-tight">分享你的學習成果！</h1>
                    <p class="text-lg text-gray-600 mb-8">
                        歡迎參加本次學習活動！在這裡，你可以上傳並展示你的精彩作品，與大家一同交流成長。
                    </p>
                     <a href="#student-works" class="inline-block bg-accent text-white font-semibold px-8 py-3 rounded-xl hover:bg-pink-700 transition duration-300 shadow-lg">
                        前往作品區
                    </a>
                </div>
                <div class="md:w-1/2 w-full mt-8 md:mt-0">
                    <img src="https://placehold.co/600x400/FFF8E1/E91E63?text=學習活動主視覺" alt="學習活動主視覺" class="rounded-2xl shadow-xl w-full h-auto object-cover">
                </div>
            </div>
        </section>

        <section id="student-works" class="py-16 md:py-24 border-t border-gray-200">
            <div class="container mx-auto px-6">
                <h2 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-12">學生作品展示與上傳</h2>

                <div class="max-w-2xl mx-auto bg-white p-6 md:p-8 rounded-xl shadow-lg mb-16">
                    <h3 class="text-2xl font-semibold text-gray-700 mb-6 text-center">上傳我的作品</h3>
                    <form id="upload-form" class="space-y-4">
                        <div>
                            <label for="work-image" class="block text-sm font-medium text-gray-700 mb-1">選擇圖片檔案：</label>
                            <input type="file" id="work-image" name="work-image" accept="image/png, image/jpeg, image/jpg, image/gif" required
                                   class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-pink-50 file:text-accent hover:file:bg-pink-100 transition duration-150 cursor-pointer border border-gray-300 rounded-lg p-2">
                             <p class="mt-1 text-xs text-gray-500">請選擇 JPG, PNG, GIF 格式的圖片，大小限制 16MB。</p>
                        </div>
                        <div>
                            <label for="work-description" class="block text-sm font-medium text-gray-700 mb-1">作品介紹：</label>
                            <textarea id="work-description" name="work-description" rows="3" required maxlength="500"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent shadow-sm text-sm"
                                      placeholder="簡單介紹一下你的作品吧... (最多 500 字)"></textarea>
                        </div>
                        <div>
                            <button type="submit"
                                    class="w-full bg-accent text-white font-semibold px-6 py-3 rounded-xl hover:bg-pink-700 transition duration-300 shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent disabled:opacity-70 disabled:cursor-not-allowed">
                                確認上傳
                            </button>
                        </div>
                    </form>
                     <div id="upload-status" class="mt-4 text-center text-sm"></div>
                </div>

                 <hr class="my-12 border-gray-300">

                <h3 class="text-2xl font-semibold text-gray-700 mb-8 text-center">作品畫廊</h3>
                <div id="work-gallery" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                    <p id="gallery-placeholder" class="text-center text-gray-500 col-span-full">正在載入作品...</p>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-gray-800 text-gray-300 py-10 mt-16">
         <div class="container mx-auto px-6 text-center">
             <p>&copy; 2025 學習活動主辦單位. 保留所有權利.</p>
             <div class="flex justify-center space-x-4 mt-4">
                 <a href="#" aria-label="Facebook" class="lucide hover:text-primary transition duration-300">&#xea7a;</a>
                 <a href="#" aria-label="Instagram" class="lucide hover:text-primary transition duration-300">&#xea4c;</a>
                 <a href="#" aria-label="Twitter" class="lucide hover:text-primary transition duration-300">&#xeac5;</a>
             </div>
         </div>
    </footer>

    <div id="interactive-cat-container" aria-label="互動小貓裝飾">
        <img id="interactive-cat-img" src="Box.png" alt="互動小貓">
    </div>

    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>

    <script>
        // --- Global Data & Config ---
        const catImageUrls = [ 'Box.png', 'Box2.png', 'Box3.png' ];
        const catNormalSpeed = 500;
        const catFastSpeed = 150;
        const MAX_DESC_LENGTH = 500; // Corresponds to textarea maxlength

        // --- Global State Variables ---
        let catImageIndex = 0;
        let catAnimationIntervalId = null;
        let isCatFast = false;
        let catFastTimeoutId = null;
        // Note: uploadedWorks array is removed as data comes from backend

        // --- Global DOM Element Variables ---
        // Initialized in DOMContentLoaded
        let workGalleryElement = null;
        let galleryPlaceholder = null;
        let uploadForm = null;
        let workImageInput = null;
        let workDescriptionInput = null;
        let uploadStatusElement = null;
        let mobileMenuButtonElement = null;
        let mobileMenuElement = null;
        let interactiveCatContainerElement = null;
        let interactiveCatImgElement = null;
        let particlesJsElement = null;


        // --- Global Utility Functions ---
        function handleImageError(imgElement, errorText = '圖片載入失敗') {
            console.error(`圖片載入失敗: ${imgElement.src}, Alt: ${imgElement.alt}`);
            imgElement.onerror = null; // Prevent infinite loop if placeholder fails
            const defaultSize = 200; // Default size for gallery images
            const size = imgElement.id === 'interactive-cat-img' ? 80 : defaultSize;
             // Use a simple, reliable placeholder source if possible
             imgElement.src = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}' viewBox='0 0 ${size} ${size}'%3E%3Crect width='100%25' height='100%25' fill='%23cccccc'/%3E%3Ctext x='50%25' y='50%25' font-family='sans-serif' font-size='14px' fill='%23ffffff' dominant-baseline='middle' text-anchor='middle'%3E${encodeURIComponent(errorText)}%3C/text%3E%3C/svg%3E`;
             imgElement.alt = errorText;
        }

        // Simple HTML escaping function to prevent XSS
        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>"']/g, tag => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;',
                '"': '&quot;', "'": '&#39;'
            }[tag] || tag));
        }

        // --- Backend Interaction Functions ---

        // Function to fetch works from backend and render them
        async function loadAndRenderWorks() {
            if (!workGalleryElement) {
                console.error("loadAndRenderWorks: Gallery element not found");
                return;
            }
            console.log("Fetching works from backend via /works...");
            workGalleryElement.innerHTML = '<p id="gallery-placeholder" class="text-center text-gray-500 col-span-full">正在載入作品...</p>'; // Show loading state

            try {
                const response = await fetch('/works'); // GET request to backend
                if (!response.ok) {
                    // Try to get error message from backend if possible
                    let errorMsg = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        if (errorData && errorData.error) {
                            errorMsg = `伺服器錯誤: ${errorData.error}`;
                        }
                    } catch (jsonError) {
                        // Ignore if response is not JSON
                    }
                    throw new Error(errorMsg);
                }

                const works = await response.json(); // Parse JSON data from backend
                console.log("Received works data:", works);

                workGalleryElement.innerHTML = ''; // Clear loading/previous state

                if (!Array.isArray(works)) {
                     throw new Error("從伺服器收到的資料格式不正確。");
                }

                if (works.length === 0) {
                    // Show placeholder if no works yet
                    workGalleryElement.innerHTML = '<p id="gallery-placeholder" class="text-center text-gray-500 col-span-full">目前還沒有人上傳作品喔！快來成為第一位吧！</p>';
                    return;
                }

                // Render each work
                works.forEach(work => {
                    if (!work || typeof work.imageUrl !== 'string' || typeof work.description !== 'string') {
                        console.warn("Skipping invalid work data:", work);
                        return; // Skip rendering if data is malformed
                    }

                    const card = document.createElement('div');
                    card.className = 'work-card fade-in'; // Add fade-in effect
                    // Use escaped data to prevent XSS
                    const escapedImageUrl = escapeHTML(work.imageUrl);
                    const escapedDescription = escapeHTML(work.description);

                    card.innerHTML = `
                        <img src="${escapedImageUrl}" alt="學生作品" loading="lazy">
                        <p>${escapedDescription}</p>
                    `;
                    // Assign onerror handler *after* creating the element
                    const imgElement = card.querySelector('img');
                    if (imgElement) {
                        imgElement.onerror = function() { handleImageError(this, `作品圖片載入失敗`); };
                    } else {
                        console.error("無法為卡片找到圖片元素:", card);
                    }
                    workGalleryElement.appendChild(card);
                });

            } catch (error) {
                console.error("無法載入作品:", error);
                workGalleryElement.innerHTML = `<p id="gallery-placeholder" class="text-center text-red-600 col-span-full">載入作品時發生錯誤：${escapeHTML(error.message)}</p>`;
            }
        }

        // Function to handle form submission (upload to backend)
        async function handleWorkUpload(event) {
            event.preventDefault(); // Prevent default form submission

            if (!workImageInput || !workDescriptionInput || !uploadForm || !uploadStatusElement) {
                 console.error("Upload form elements not found");
                 alert("頁面載入似乎不完整，部分功能可能無法使用，請嘗試重新整理。");
                 return;
            }

            const imageFile = workImageInput.files[0];
            const description = workDescriptionInput.value.trim();
            const submitButton = uploadForm.querySelector('button[type="submit"]');

            // Clear previous status messages
            uploadStatusElement.textContent = '';
            uploadStatusElement.className = 'mt-4 text-center text-sm'; // Reset class

            // Basic Frontend Validation
            if (!imageFile) {
                uploadStatusElement.textContent = '請選擇要上傳的圖片檔案！';
                uploadStatusElement.classList.add('text-red-600');
                return;
            }
            if (!description) {
                uploadStatusElement.textContent = '請輸入作品介紹！';
                uploadStatusElement.classList.add('text-red-600');
                return;
            }
            if (description.length > MAX_DESC_LENGTH) {
                 uploadStatusElement.textContent = `作品介紹過長，請勿超過 ${MAX_DESC_LENGTH} 字。`;
                 uploadStatusElement.classList.add('text-red-600');
                 return;
            }

            // Check file type (basic check, backend validation is primary)
             const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif'];
             if (!allowedTypes.includes(imageFile.type)) {
                 uploadStatusElement.textContent = '不支援的圖片格式。請選擇 PNG, JPG, 或 GIF。';
                 uploadStatusElement.classList.add('text-red-600');
                 return;
             }

             // Check file size (example: 16MB limit)
             const maxSize = 16 * 1024 * 1024;
             if (imageFile.size > maxSize) {
                 uploadStatusElement.textContent = `檔案大小超過限制 (最大 ${maxSize / 1024 / 1024}MB)。`;
                 uploadStatusElement.classList.add('text-red-600');
                 return;
             }

            // Use FormData to package file and text data
            const formData = new FormData();
            formData.append('work-image', imageFile); // Key matches backend 'request.files'
            formData.append('work-description', description); // Key matches backend 'request.form'

            // Disable button and show uploading state
            if(submitButton) {
                submitButton.disabled = true;
                submitButton.textContent = '上傳中...';
            }
            uploadStatusElement.textContent = '正在上傳作品...';
            uploadStatusElement.classList.add('text-blue-600');


            try {
                // Send POST request to the backend /upload endpoint
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData // Let browser set Content-Type for FormData
                });

                const result = await response.json(); // Parse JSON response from backend

                if (response.ok && result.success) {
                    uploadStatusElement.textContent = '作品上傳成功！畫廊正在更新...';
                    uploadStatusElement.classList.remove('text-red-600', 'text-blue-600');
                    uploadStatusElement.classList.add('text-green-600');
                    if(uploadForm) uploadForm.reset(); // Clear the form fields
                    await loadAndRenderWorks(); // Refresh the gallery to show the new work
                    // Optionally hide success message after a delay
                    setTimeout(() => { uploadStatusElement.textContent = ''; }, 5000);

                } else {
                    // Display error message from backend response
                    const errorMsg = result.error || '發生未知錯誤';
                    uploadStatusElement.textContent = `上傳失敗: ${escapeHTML(errorMsg)}`;
                    uploadStatusElement.classList.remove('text-blue-600', 'text-green-600');
                    uploadStatusElement.classList.add('text-red-600');
                    console.error("Upload failed:", result);
                }

            } catch (error) {
                uploadStatusElement.textContent = '上傳過程中發生網路或伺服器連線錯誤。';
                uploadStatusElement.classList.remove('text-blue-600', 'text-green-600');
                uploadStatusElement.classList.add('text-red-600');
                console.error("Error during fetch /upload:", error);
            } finally {
                // Re-enable button regardless of success or failure
                if(submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = '確認上傳';
                }
            }
        }


        // --- Existing Functions (Cat, Mobile Menu, Particles) ---
        // These functions remain largely the same as your original code

        function toggleMobileMenu(mobileMenuElem) {
            if (mobileMenuElem) {
                mobileMenuElem.classList.toggle('hidden');
                // Optional: Change button icon based on state
                const button = document.getElementById('mobile-menu-button');
                 if(button){
                     button.textContent = mobileMenuElem.classList.contains('hidden') ? '\ue9af' : '\uea13'; // Menu vs X icon
                 }
            }
        }

        function stopCatAnimation() {
            if (catAnimationIntervalId) {
                clearInterval(catAnimationIntervalId);
                catAnimationIntervalId = null;
            }
             if (catFastTimeoutId) {
                clearTimeout(catFastTimeoutId);
                catFastTimeoutId = null;
            }
            isCatFast = false;
        }

        function startCatAnimation(speed, catImgElem) {
             stopCatAnimation(); // Clear any existing animation first
             if(!catImgElem || catImageUrls.length === 0) return;

             catAnimationIntervalId = setInterval(() => {
                catImageIndex = (catImageIndex + 1) % catImageUrls.length;
                catImgElem.src = catImageUrls[catImageIndex];
             }, speed);
        }

        function handleCatClick(catContainerElem, catImgElem) {
             if(!catContainerElem || !catImgElem) return;

             if (!isCatFast) {
                isCatFast = true;
                startCatAnimation(catFastSpeed, catImgElem);
                // Set timeout to return to normal speed
                catFastTimeoutId = setTimeout(() => {
                    isCatFast = false;
                    startCatAnimation(catNormalSpeed, catImgElem);
                 }, 2000); // Fast animation duration (e.g., 2 seconds)
             }
        }

        function initParticles(particlesElem) {
             if (typeof particlesJS === 'undefined') {
                 console.error('particles.js library not loaded.');
                 return;
             }
             if (particlesElem) {
                  console.log("Initializing Particles.js");
                 particlesJS("particles-js", { /* Particles config from your original code */
                   "particles": { "number": { "value": 80, "density": { "enable": true, "value_area": 800 } }, "color": { "value": "#888888" }, "shape": { "type": "circle", "stroke": { "width": 0, "color": "#000000" }, "polygon": { "nb_sides": 5 }, "image": { "src": "img/github.svg", "width": 100, "height": 100 } }, "opacity": { "value": 0.5, "random": false, "anim": { "enable": false, "speed": 1, "opacity_min": 0.1, "sync": false } }, "size": { "value": 3, "random": true, "anim": { "enable": false, "speed": 40, "size_min": 0.1, "sync": false } }, "line_linked": { "enable": true, "distance": 150, "color": "#888888", "opacity": 0.4, "width": 1 }, "move": { "enable": true, "speed": 6, "direction": "none", "random": false, "straight": false, "out_mode": "out", "bounce": false, "attract": { "enable": false, "rotateX": 600, "rotateY": 1200 } } }, "interactivity": { "detect_on": "canvas", "events": { "onhover": { "enable": true, "mode": "repulse" }, "onclick": { "enable": true, "mode": "push" }, "resize": true }, "modes": { "grab": { "distance": 400, "line_linked": { "opacity": 1 } }, "bubble": { "distance": 400, "size": 40, "duration": 2, "opacity": 8, "speed": 3 }, "repulse": { "distance": 200, "duration": 0.4 }, "push": { "particles_nb": 4 }, "remove": { "particles_nb": 2 } } }, "retina_detect": true
                 });
             } else {
                 console.error("Particles.js container element (#particles-js) missing.");
             }
        }

        // --- Main Execution on DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded event fired. Initializing page...");

            // --- Assign DOM Elements to Global Variables ---
            workGalleryElement = document.getElementById('work-gallery');
            galleryPlaceholder = document.getElementById('gallery-placeholder'); // Used for loading/empty states
            uploadForm = document.getElementById('upload-form');
            workImageInput = document.getElementById('work-image');
            workDescriptionInput = document.getElementById('work-description');
            uploadStatusElement = document.getElementById('upload-status'); // For showing upload feedback
            mobileMenuButtonElement = document.getElementById('mobile-menu-button');
            mobileMenuElement = document.getElementById('mobile-menu');
            interactiveCatContainerElement = document.getElementById('interactive-cat-container');
            interactiveCatImgElement = document.getElementById('interactive-cat-img');
            particlesJsElement = document.getElementById('particles-js');

            // Check if all critical elements exist
            if (!workGalleryElement || !uploadForm || !workImageInput || !workDescriptionInput || !uploadStatusElement) {
                console.error("一個或多個必要的 DOM 元素未找到。頁面功能可能受影響。");
                // Optionally display a user-facing error
                const body = document.querySelector('body');
                if(body) {
                     const errorDiv = document.createElement('div');
                     errorDiv.textContent = '頁面載入錯誤，請重新整理或聯絡管理員。';
                     errorDiv.style.color = 'red';
                     errorDiv.style.padding = '1em';
                     errorDiv.style.textAlign = 'center';
                     body.insertBefore(errorDiv, body.firstChild);
                }
                return; // Stop further initialization if critical elements are missing
            }


            // --- Initialize Page Components ---
            function initializePage() {
                console.log("initializePage: 函數開始執行");

                // Load works from backend as soon as possible
                loadAndRenderWorks();

                // Initialize cat animation if element exists
                if(interactiveCatImgElement) {
                     // Ensure initial cat image is set and has error handling
                     interactiveCatImgElement.onerror = function() { handleImageError(this, 'Cat Error'); };
                     if (!interactiveCatImgElement.getAttribute('src')) {
                         interactiveCatImgElement.src = catImageUrls[0] || ''; // Set initial image if missing
                     }
                    startCatAnimation(catNormalSpeed, interactiveCatImgElement);
                } else {
                    console.warn("互動小貓圖片元素未找到。");
                }

                // Initialize particles if element exists
                if(particlesJsElement) {
                    initParticles(particlesJsElement);
                } else {
                     console.warn("Particles.js 容器元素未找到。");
                }

                console.log("initializePage: 函數執行完畢");
            }

            initializePage(); // Run Initialization

            // --- Bind Event Listeners ---

            // Upload Form Submission
            if (uploadForm) {
                uploadForm.addEventListener('submit', handleWorkUpload); // Use the async handler
                console.log("已綁定上傳表單的 submit 事件。");
            }
            // No need for 'else' error log here, already checked above

            // Smooth Scrolling for internal links
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                 anchor.addEventListener('click', function (e) {
                     e.preventDefault();
                     const targetId = this.getAttribute('href');
                     try {
                         const targetElement = document.querySelector(targetId);
                         if(targetElement) {
                             targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                             // Close mobile menu if a link inside it is clicked
                             if (mobileMenuElement && !mobileMenuElement.classList.contains('hidden') && mobileMenuElement.contains(this)) {
                                 toggleMobileMenu(mobileMenuElement);
                             }
                         } else {
                             console.warn(`平滑滾動目標未找到: ${targetId}`);
                         }
                     } catch (error) {
                         console.error(`選擇器錯誤或無效的 targetId '${targetId}':`, error);
                     }
                 });
            });
            console.log("已綁定平滑滾動事件。");

            // Mobile Menu Toggle Button
            if (mobileMenuButtonElement) {
                mobileMenuButtonElement.addEventListener('click', () => toggleMobileMenu(mobileMenuElement));
                console.log("已綁定行動選單按鈕的 click 事件。");
            } else { console.error("未找到行動選單按鈕。"); }

            // Interactive Cat Click
            if (interactiveCatContainerElement) {
                interactiveCatContainerElement.addEventListener('click', () => handleCatClick(interactiveCatContainerElement, interactiveCatImgElement));
                console.log("已綁定互動小貓容器的 click 事件。");
            } else { console.error("未找到互動小貓容器。"); }


             // Assign onerror for the main visual image as well (if it exists)
             const mainVisualImg = document.querySelector('#home img');
              if(mainVisualImg){
                  mainVisualImg.onerror = function() { handleImageError(this, '主視覺載入失敗'); };
                  console.log("已為主視覺圖片綁定 error 事件。");
              }


        }); // End of DOMContentLoaded listener

    </script>
</body>
</html>